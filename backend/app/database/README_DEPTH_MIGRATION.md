# 探索深度によるキャッシュ管理の改善

## 問題点

以前の実装では、トランザクションのキャッシュ判断がトランザクションIDと数量等の基本情報のみに基づいていました。そのため、ネットワーク可視化時に探索深度を変更した場合（例：深度1から深度3へ）、システムは誤ってキャッシュデータが十分であると判断し、追加のデータを取得しませんでした。

## 解決策

この問題を解決するために、以下の変更を行いました：

1. トランザクションモデルに `fetch_depth` フィールドを追加し、各トランザクションがどの探索深度で取得されたかを記録します。
2. キャッシュ判断ロジックを更新し、リクエストされた探索深度が既存のキャッシュデータの深度以下の場合のみキャッシュを使用するようにしました。
3. 既存のトランザクションデータに対して、より深い探索深度でリクエストがあった場合は、深度情報を更新するようにしました。

## マイグレーションの適用方法

既存のデータベースに `fetch_depth` 列を追加するには、以下のコマンドを実行してください：

```bash
cd backend
python -m app.database.add_fetch_depth_column
```

このスクリプトは既存の `transactions` テーブルに `fetch_depth` 列を追加します。既に列が存在する場合は何も変更されません。

## 動作確認方法

1. マイグレーションスクリプトを実行して、データベースを更新します。
2. アプリケーションを再起動します。
3. ネットワーク可視化ページで、以下の手順でテストします：
   - あるアドレスに対して深度1で探索を実行
   - 同じアドレスに対して深度3で探索を実行
   - 深度3の結果には、深度1では表示されなかった追加のノードとリンクが含まれているはずです

## 技術的な詳細

- `get_cached_transactions` メソッドは、リクエストされた深度以上の深度を持つトランザクションのみを返すようになりました。
- `save_transactions_to_db` メソッドは、既存のトランザクションの深度が新しいリクエストの深度より小さい場合、深度情報を更新するようになりました。
- API エンドポイントは、トランザクション取得時に深度パラメータを渡すようになりました。
